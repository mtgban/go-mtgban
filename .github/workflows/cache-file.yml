name: Download and cache a file

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Where to download from"
        required: true
        type: string
      path:
        description: "Where to download to"
        required: true
        type: string
        default: "datastore/"
      game:
        description: "If set, where to save the result and ping to"
        type: string

  workflow_call:
    inputs:
      url:
        required: true
        type: string
      path:
        required: true
        type: string
      game:
        type: string
    outputs:
      key:
        description: "Key of the cache to retrieve"
        value: ${{ jobs.cache-file.outputs.key }}
      filepath:
        description: "Where the file will be availble at"
        value: ${{ jobs.cache-file.outputs.filepath }}

jobs:
  cache-file:
    runs-on: ubuntu-latest
    outputs:
      key: ${{ steps.get_etag.outputs.key }}
      filepath: ${{ steps.get_etag.outputs.filepath }}
    steps:
      - name: Fetch file checksum
        id: get_etag
        run: |
          etag=$(curl -sI "${{ inputs.url }}" | grep -i etag | tr -d '\r"' | cut -f 2 -d " ")
          base=$(basename "${{ inputs.url }}" | cut -d? -f1)
          key=$base-$etag
          filepath=${{ inputs.path }}$base
          echo "key=$key" >> $GITHUB_OUTPUT
          echo "filepath=$filepath" >> $GITHUB_OUTPUT

      - name: Cache path
        id: cache-file
        uses: actions/cache@v4
        with:
          path: ${{ inputs.path }}
          key: ${{ steps.get_etag.outputs.key }}

      - if: steps.cache-file.outputs.cache-hit != 'true'
        name: Download file
        run: |
          mkdir -p "${{ inputs.path }}"
          curl -L "${{ inputs.url }}" -o "${{ steps.get_etag.outputs.filepath }}"

      - if: steps.cache-file.outputs.cache-hit != 'true' && inputs.game != ''
        name: Upload to B2
        env:
          B2KEY: "${{ secrets.B2_KEY_ID_DATASTORE }}"
          B2SECRET: "${{ secrets.B2_APP_KEY_DATASTORE }}"
        run: |
          pip install --quiet --no-cache-dir b2
          b2 account authorize $B2KEY $B2SECRET
          b2 sync --skip-newer "${{ inputs.path }}" "b2://mtgban-datastore/${{ inputs.game }}"
          b2 account clear

      - if: steps.cache-file.outputs.cache-hit != 'true' && inputs.game != ''
        name: Ping server
        env:
          BAN_SECRET: "${{ secrets.BAN_SECRET }}"
        run: |
          ts=$(date -u +%s)
          body=$(jq -n --arg ts "$ts" '{ts:($ts|tonumber)}')
          sig=$(printf '%s' "$body" | openssl dgst -sha256 -hmac "$BAN_SECRET" -binary | base64)
          curl -L -X POST \
              -H 'Content-Type: application/json' \
              -H "X-Signature: $sig" \
              -H "X-Timestamp: $ts" \
              --data-raw "$body" \
              "https://${{ inputs.game }}.mtgban.com/api/load/datastore" 2> /dev/null | tee /dev/stderr | jq -e 'select(.status=="ok")'
